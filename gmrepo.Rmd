```{r}
library(phyloseq)
library(ggplot2)
library(microbiome)
library(microbiomeutilities)
library(ranacapa)
library(plotly)

library(microViz)
library(ggpubr)
library(htmlwidgets)

library(ANCOMBC)
library(Maaslin2)
```

```{r}
# metadata
meta_df <- read.csv("data/alternative/total.csv", sep = ",", header = TRUE)
rownames(meta_df) <- meta_df$run.ID
meta_df$associated.phenotype <- as.factor(meta_df$associated.phenotype)
meta_df$host.age <- as.integer(meta_df$host.age)
meta_df$BMI <- as.integer(meta_df$BMI)
head(meta.df)

summary(meta_df$associated.phenotype)
summary(meta_df$host.age)
summary(meta_df$BMI)

sampledata <- sample_data(meta_df)
sample_names(sampledata) <- meta_df$run.ID
head(sampledata)

# count table
abs_count_df <- read.csv(
  "data/alternative/absolute_count_raw.csv",
  sep = "\t",
  header = TRUE
)
rownames(abs_count_df) <- abs_count_df$query_name
abs_count_df <- subset(abs_count_df, select = -query_name)
otu <- otu_table(as.matrix(t(abs_count_df)), taxa_are_rows = TRUE)

# asv table
taxa_df <- read.csv("data/alternative/tax_table.csv", sep = "\t", header = TRUE)
rownames(taxa_df) <- taxa_df$Ident
taxa_df <- subset(taxa_df, select = -c(Ident, X, Gtdb_representative))
head(taxa_df)

tax <- tax_table(as.matrix(taxa_df))
```

```{r}
meta_df

ggplot(meta_df, aes(associated.phenotype, host.age)) +
  geom_boxplot(aes(fill = sex)) +
  geom_jitter()
```
```{r}
physeq <- phyloseq(otu, tax, sampledata)
```

# Remove singleton
```{r}
#sort sample total reads, prune taxa
all.ps <- phyloseq::prune_taxa(phyloseq::taxa_sums(physeq) > 0, physeq)

#explore singleton
all.tx.pres <- rowSums(abundances(all.ps) > 0)
all.singleton <- as.vector(
  as.matrix(
    tax_table(all.ps)[names(which(all.tx.pres == 1)), "Genus"]
  )
)
all.singleton #793 singleton taxa

names(all.singleton) <- rownames(
  tax_table(all.ps)[names(which(all.tx.pres == 1)), "Genus"]
)
sort(table(all.singleton),
     decreasing = TRUE)

## most common singleton taxa are

#counts of each singleton taxa
sort(taxa_sums(all.ps)[names(all.singleton)], decreasing = TRUE)
summary(taxa_sums(all.ps)[names(all.singleton)]) #median 198 // 3rd quartile 515

table(
  all.singleton[names(which(taxa_sums(all.ps)[names(all.singleton)] < 515))]
)
all.taxa.rm <- names(which(taxa_sums(all.ps)[names(all.singleton)] < 515))

## Remove singleton taxa that have read abundance < 515 reads
all.fil <- prune_taxa(!(taxa_names(all.ps) %in% all.taxa.rm), all.ps)
all.fil #3985 taxa
summary(sample_sums(all.fil) / sample_sums(all.ps)) #median 100%

all.ggrare <- ggrare(
  all.fil,
  step = 100,
  label = NULL,
  color = "associated.phenotype"
)
all.ggrare.plot <- all.ggrare +
  # xlim(0, 3000) +
  theme(legend.position = "bottom") +
  theme_classic()

all.ggrare.plot

sort(sample_sums(all.fil))
```

# PCoA
```{r}
ord <- ordinate(all.fil, "PCoA", "bray")

#Plot scree plot
phyloseq::plot_scree(ord) +
  geom_bar(stat = "identity", fill = "firebrick") +
  scale_x_discrete(limits = c(1:10)) +
  labs(x = "Axis", y = "Proportion of Variance")

plot_ordination(all.fil, ord,
  type = "samples",
  shape = "associated.phenotype",
  color = "project.ID"
)
```

# A-div
```{r}
adiv <- data.frame(
  "Shannon" = phyloseq::estimate_richness(all.fil, measures = "Shannon"),
  "Simpson" = phyloseq::estimate_richness(all.fil, measures = "Simpson"),
  "Chao1" = phyloseq::estimate_richness(all.fil, measures = "Chao1"),
  "Age" = sample_data(all.fil)$host.age,
  "Disease" = sample_data(all.fil)$associated.phenotype
)

adiv <- subset(adiv, select = -Chao1.se.chao1)
names(adiv)[3] <- "Chao1"

adiv$Disease <- as.factor(adiv$Disease)
adiv$Age <- as.factor(adiv$Age)

# plot
comps <- make_pairs(sample_data(all.fil)$associated.phenotype)

ggplot(adiv, aes(Disease, Shannon)) +
  geom_violin() +
  geom_boxplot(width = 0.5) +
  # geom_jitter() +
  stat_compare_means(
    comparisons = comps,
    method = "wilcox.test",
    paired = FALSE
  )
```

# Tukey post hoc test
```{r}
adiv
#Shannon
shan_div <- adiv[, c("Shannon", "Disease")]
tukey_shan <- TukeyHSD(aov(lm(Shannon ~ Disease,
                              shan_div)))$Disease
tukey_shan <- as.data.frame(tukey_shan)

tukey_shan[order(tukey_shan$`p adj`), ]

#Simpson
simp_div <- adiv[, c("Simpson", "Disease")]
tukey_simp <- TukeyHSD(aov(lm(Simpson ~ Disease,
                              simp_div)))$Disease
tukey_simp <- as.data.frame(tukey_simp)

tukey_simp[order(tukey_simp$`p adj`), ]

#Chao1
chao1_div <- adiv[, c("Chao1", "Disease")]
tukey_chao1 <- TukeyHSD(aov(lm(Chao1 ~ Disease,
                               chao1_div)))$Disease
tukey_chao1 <- as.data.frame(tukey_chao1)

tukey_chao1[order(tukey_chao1$`p adj`), ]
```

```{r}
# standard error
se <- function(x) sd(x) / sqrt(length(x))
```

# Phylum
```{r}
ps_phylum <- microbiome::aggregate_rare(all.fil,
  level = "Phylum",
  detection = 0.1,
  prevalence = 0
)

abund_df <- microbiomeutilities::phy_to_ldf(
  ps_phylum,
  transform.counts = "compositional"
)

ggplot(abund_df, aes(x = Sam_rep, y = Abundance, fill = Phylum)) +
  geom_bar(position = "fill",
    stat = "identity"
  )



top_phylum <- abund_df %>%
  group_by(Phylum) %>%
  summarise(mean_abundance = mean(Abundance),
            se = se(Abundance),
            median = median(Abundance),
            q1 = quantile(Abundance)[2],
            q3 = quantile(Abundance)[4]) %>%
  ungroup()

top_phylum <- top_phylum %>% arrange(desc(mean_abundance))
top_phylum <- as.data.frame(top_phylum)
top_phyla <- head(top_phylum$Phylum, n = 10)


abund_df <- abund_df %>%
  dplyr::mutate(pick_Phylum = ifelse(Phylum %in%
                                       top_phyla,
                                     yes = Phylum,
                                     "Others"))

# Plot
abund_df$pick_Phylum <- as.factor(abund_df$pick_Phylum)
abund_df$pick_Phylum <- factor(abund_df$pick_Phylum,
  levels = c(top_phyla, "Others")
)

abund_df <- abund_df[order(abund_df$host.age, decreasing = FALSE), ]

abund_plot <-
  ggplot(abund_df, aes(x = Sam_rep, y = Abundance, fill = pick_Phylum)) +
  geom_bar(position = "fill", stat = "identity") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

# Genus
```{r}
ps_genus <- microbiome::aggregate_rare(all.fil,
  level = "Genus",
  detection = 0.1,
  prevalence = 0
)

abund_df <- microbiomeutilities::phy_to_ldf(
  ps_genus,
  transform.counts = "compositional"
)

top_genus <- abund_df %>%
  group_by(Genus) %>%
  summarise(mean_abundance = mean(Abundance),
            se = se(Abundance),
            median = median(Abundance),
            q1 = quantile(Abundance)[2],
            q3 = quantile(Abundance)[4]) %>%
  ungroup()

top_genus <- top_genus %>% arrange(desc(mean_abundance))
top_genus <- as.data.frame(top_genus)


abund_df <- abund_df %>%
  dplyr::mutate(pick_genus = ifelse(Genus %in% top_genus,
                                    yes = Genus,
                                    "Others"))

# Plot
abund_df$pick_genus <- as.factor(abund_df$pick_genus)
abund_df$pick_genus <- factor(abund_df$pick_genus,
  levels = c(top_genus, "Others")
)

abund_df <- abund_df[order(abund_df$host.age, decreasing = FALSE), ]

abund_plot <-
  ggplot(abund_df, aes(x = Sam_rep, y = Abundance, fill = pick_Phylum)) +
  geom_bar(position = "fill", stat = "identity") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

```{r}
## update on heatmap plot functions
make_hcb <- function(data, var, name = NULL, fill_scale = NULL, ...) {
  hcb <- ggplot(data = data, aes_string(x = "index", y = 1, fill = var)) +
    geom_raster(show.legend = TRUE) +
    scale_y_continuous(expand = c(0, 0), breaks = 1, labels = name) +
    scale_x_continuous(expand = c(0, 0)) +
    xlab(NULL) + ylab(NULL) +
    theme(axis.title = element_blank(), axis.ticks = element_blank()) +
    theme(axis.text.x = element_blank()) +
    theme(axis.text.y = element_text(size = 12, face = "bold")) +
    theme(plot.margin = unit(c(0, 0, 0, 0), "lines")) +
    guides(fill = FALSE)
  if (!is.null(fill_scale)) hcb <- hcb + fill_scale
  return(hcb)
}

mush <- function(hmap, hcbs) {
  require(gtable)
  require(grid)
  require(gridExtra)
  cbgs <- lapply(hcbs, ggplotGrob)
  hmg <- ggplotGrob(hmap)
  # Make sure both plots have the same dimensions in grob objects
  for (i in seq_along(cbgs)) {
    cbgs[[i]] <- gtable_add_cols(cbgs[[i]], widths = unit(1, "null"), pos = 8)
    cbgs[[i]] <- gtable_add_cols(cbgs[[i]], widths = unit(1, "null"), pos = 8)
  }
  ## Make sure that both plots have the same widths
  cbwidths <- lapply(cbgs, function(x) x$widths)
  maxwidth <- do.call(unit.pmax, cbwidths)
  maxwidth <- unit.pmax(hmg$widths, maxwidth)
  ## replace widths in each grob object with maxWidth
  hmg$widths <- maxwidth
  for (i in seq_along(cbgs)){
    cbgs[[i]]$widths <- maxwidth
  }
  heights <- unit.c(unit(rep(1, length(cbgs)), "lines"), unit(1, "null"))
  rval <- do.call(arrangeGrob,
                  args = c(cbgs,
                           list(hmg),
                           ncol = 1,
                           heights = list(heights)))
  return(rval)
}
```

# Filter phyloseq
```{r}
ps_1 <- ps_filter(all.fil, associated.phenotype != "D000236") # Health vs CRC
ps_2 <- ps_filter(all.fil, associated.phenotype != "D015179") # Health vs Ad
ps_3 <- ps_filter(all.fil, associated.phenotype != "D006262") # CRC vs Ad
```

# Differential abundance

```{r}
mas_1 <- Maaslin2(
  input_data = data.frame(otu_table(ps_1)),
  input_metadata = data.frame(sample_data(ps_1)),
  output = "output/",
  min_abundance = 0,
  min_prevalence = 0,
  normalization = "NONE",
  transform = "LOG",
  analysis_method = "LM",
  fixed_effects = "associated.phenotype",
  random_effects = c("host.age", "sex", "BMI"),
  reference = "run.ID",
  plot_heatmap = FALSE,
  plot_scatter = FALSE,
  standardize = FALSE,
  cores = 22
)

dfmas_res_1 <- mas_1$results

fdr_mas_1 <- dfmas_res_1

fdr_mas_1$Species <-  phyloseq::tax_table(ps_1)[fdr_mas_1$feature, "Species"]

dim(fdr_mas_1) #307 species
head(fdr_mas_1[order(fdr_mas_1$coef, decreasing = TRUE), ], n = 50)

fc_mas_1 <- exp(fdr_mas_1$coef) ## Antilog coef
fdr_mas_1$log2FoldChange <- log2(fc_mas_1)
rownames(fdr_mas_1) <- fdr_mas_1$feature

fdr_mas_1$Species <- as.character(unclass(fdr_mas_1$Species))
```

# ANCOMBC
```{r}
ps_1
ps_1_keep <- prune_taxa(rowSums(abundances(ps_1) > 0) >= 17,
  ps_1
) #at least 17 samples = 10% of the pool
patient.17.keep #134 samples and 222 taxa
summary(sample_sums(ps_1_keep) / sample_sums(ps_1)) #98.19% data is covered

#----------#
#ANCOMBC
ancom_1 <- ancombc(data = ps_1_keep,
                   formula = "run.ID + associated.phenotype",
                   tax_level = NULL,
                   p_adj_method = "fdr",
                   lib_cut = 1000,
                   prv_cut = 0.001,
                   group = "associated.phenotype",
                   struc_zero = TRUE,
                   neg_lb = TRUE,
                   tol = 1e-05,
                   alpha = 0.05,
                   global = FALSE)

output <- ancombc2(data = ps_1, assay_name = "counts", tax_level = "Family",
                   fix_formula = "run.ID + associated.phenotype",
                   rand_formula = NULL,
                   p_adj_method = "holm", pseudo_sens = TRUE,
                   prv_cut = 0.10, lib_cut = 1000, s0_perc = 0.05,
                   group = "associated.phenotype",
                   struc_zero = TRUE, neg_lb = TRUE,
                   alpha = 0.05, n_cl = 2, verbose = TRUE,
                   global = TRUE, pairwise = TRUE, dunnet = TRUE, trend = TRUE,
                   iter_control = list(tol = 1e-2, max_iter = 20,
                                       verbose = TRUE),
                   em_control = list(tol = 1e-5, max_iter = 100),
                   lme_control = lme4::lmerControl(),
                   mdfdr_control = list(fwer_ctrl_method = "holm", B = 100),
                   trend_control = list(contrast = list(matrix(c(1, 0, -1, 1),
                                                               nrow = 2,
                                                               byrow = TRUE),
                                                        matrix(c(-1, 0, 1, -1),
                                                               nrow = 2,
                                                               byrow = TRUE),
                                                        matrix(c(1, 0, 1, -1),
                                                               nrow = 2,
                                                               byrow = TRUE)),
                                        node = list(2, 2, 1),
                                        solver = "ECOS",
                                        B = 10))
## consider conserve=TRUE -> "sample size > 30" = large
```

# Visualization
```{r}
volcano_1 <- ggplot(fdr_mas_1, aes(x = log2FoldChange,
                                   y = -log10(qval),
                                   Species = Species)) +
  geom_hline(aes(yintercept = max(-log10(qval))),
             linetype = "dashed",
             color = "grey30") +
  geom_point(data = subset(fdr_mas_1, qval > 0.05),
             size = 3, color = "grey30") +
  geom_point(data = subset(fdr_mas_1, qval <= 0.05 & log2FoldChange < 0),
             size = 3, color = "#457b9d") +
  geom_point(data = subset(fdr_mas_1, qval <= 0.05 & log2FoldChange > 0),
             size = 3, color = "#d62828") +
  geom_hline(yintercept = -log10(0.05), col = "grey30",
             linetype = 1) +
  geom_vline(xintercept = 0, col = "grey30",
             linetype = 1) +
  geom_text(aes(x = 3, y = -log10(0.03), label = "q-value = 0.05"),
            hjust = 1, vjust = 0,
            color = "grey30",
            size = 5) +
  # scale_y_continuous(expand = c(0, 0), limits = c(0, 15)) +
  scale_x_continuous(expand = c(0, 0), limits = c(-4, 4))  +
  theme_classic() +
  labs(title = "Differential abundance",
       subtitle = "Healthy (left) vs CRC (right)") +
  theme(plot.title = element_text(size = 10, face = "bold",
                                  vjust = 0, hjust = 0),
        plot.subtitle = element_text(size = 10,
                                     color = "grey50",
                                     vjust = 0, hjust = 0),
        axis.title.x = element_text(vjust = 0, hjust = 0.5, size = 10),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.line.y.left = element_blank()) +
  geom_segment(aes(x = -4, y = -Inf,
                   xend = -4, yend = max(-log10(qval))),
               size = 1, linetype = "solid") +
  geom_segment(aes(x = -4, y = max(-log10(qval)),
                   xend = -4, yend = Inf),
               size = 1, linetype = "dotted")

ggplotly(volcano_1, tooltip = c("log2FoldChange", "-log10(qval)", "Species"))
saveWidget(ggplotly(volcano_1,
                    tooltip = c("log2FoldChange",
                                "-log10(qval)",
                                "Species")),
           file = "maaslin2.html")
```