```{r}
library(phyloseq)
library(ggplot2)
library(microbiome)
library(microbiomeutilities)
library(ranacapa)
```

```{r}
# metadata
meta_df <- read.csv("sample_data/total.csv", sep = ",", header = TRUE)
rownames(meta_df) <- meta.df$run.ID
head(meta.df)

sampledata <- sample_data(meta_df)
sample_names(sampledata) <- meta_df$run.ID
head(sampledata)

# count table
abs_count_df <- read.csv("absolute_count_raw.csv", sep = "\t", header = TRUE)
rownames(abs_count_df) <- abs_count_df$query_name
abs_count_df <- subset(abs_count_df, select = -query_name)
otu <- otu_table(as.matrix(t(abs_count_df)), taxa_are_rows = TRUE)

# asv table
taxa_df <- read.csv("tax_table.csv", sep = "\t", header = TRUE)
rownames(taxa_df) <- taxa_df$Ident
taxa_df <- subset(taxa_df, select = -c(Ident, X, Gtdb_representative))
head(taxa_df)

tax <- tax_table(as.matrix(taxa_df))
```


```{r}
physeq <- phyloseq(otu, tax, sampledata)
```

# Remove singleton
```{r}
#sort sample total reads, prune taxa
all.ps <- phyloseq::prune_taxa(phyloseq::taxa_sums(physeq) > 0, physeq)

#explore singleton
all.tx.pres <- rowSums(abundances(all.ps) > 0)
all.singleton <- as.vector(
  as.matrix(
    tax_table(all.ps)[names(which(all.tx.pres == 1)), "Genus"]
  )
)
all.singleton #793 singleton taxa

names(all.singleton) <- rownames(
  tax_table(all.ps)[names(which(all.tx.pres == 1)), "Genus"]
)
sort(table(all.singleton),
     decreasing = TRUE)

## most common singleton taxa are

#counts of each singleton taxa
sort(taxa_sums(all.ps)[names(all.singleton)], decreasing = TRUE)
summary(taxa_sums(all.ps)[names(all.singleton)]) #median 198 // 3rd quartile 515

table(
  all.singleton[names(which(taxa_sums(all.ps)[names(all.singleton)] < 515))]
)
all.taxa.rm <- names(which(taxa_sums(all.ps)[names(all.singleton)] < 515))

## Remove singleton taxa that have read abundance < 515 reads
all.fil <- prune_taxa(!(taxa_names(all.ps) %in% all.taxa.rm), all.ps)
all.fil #3985 taxa
summary(sample_sums(all.fil) / sample_sums(all.ps)) #median 100%

all.ggrare <- ggrare(
  all.fil,
  step = 100,
  label = NULL,
  color = "associated.phenotype"
)
all.ggrare.plot <- all.ggrare +
  # xlim(0, 3000) +
  theme(legend.position = "bottom") +
  theme_classic()

all.ggrare.plot

sort(sample_sums(all.fil))
```

# PCoA
```{r}
ord <- ordinate(physeq, "PCoA", "bray")

#Plot scree plot
phyloseq::plot_scree(ord) +
  geom_bar(stat = "identity", fill = "firebrick") +
  scale_x_discrete(limits = c(1:10)) +
  labs(x = "Axis", y = "Proportion of Variance")

plot_ordination(physeq, ord, type = "samples", color = "associated.phenotype")
```

# A-div
```{r}
adiv <- data.frame(
  "Shannon" = phyloseq::estimate_richness(all.fil, measures = "Shannon"),
  "Simpson" = phyloseq::estimate_richness(all.fil, measures = "Simpson"),
  "Chao1" = phyloseq::estimate_richness(all.fil, measures = "Chao1"),
  "Age" = sample_data(all.fil)$host.age,
  "Disease" = sample_data(all.fil)$associated.phenotype
)

adiv <- subset(adiv, select = -Chao1.se.chao1)
adiv$Disease <- as.factor(adiv$Disease)
adiv$Age <- as.factor(adiv$Age)

# plot
comps <- make_pairs(sample_data(all.fil)$associated.phenotype)

ggplot(adiv, aes(Disease, Shannon)) +
  geom_violin() +
  geom_boxplot(width = 0.5) +
  # geom_jitter() +
  stat_compare_means(
    comparisons = comps,
    method = "wilcox.test",
    paired = FALSE
  )
```

```{r}
# standard error
se <- function(x) sd(x) / sqrt(length(x))
```

# Phylum
```{r}
ps_phylum <- microbiome::aggregate_rare(all.fil,
  level = "Phylum",
  detection = 0.1,
  prevalence = 0
)

abund_df <- microbiomeutilities::phy_to_ldf(
  ps_phylum,
  transform.counts = "compositional"
)

ggplot(abund_df, aes(x = Sam_rep, y = Abundance, fill = Phylum)) +
  geom_bar(position = "fill",
    stat = "identity"
  )



top_phylum <- abund_df %>%
  group_by(Phylum) %>%
  summarise(mean_abundance = mean(Abundance),
            se = se(Abundance),
            median = median(Abundance),
            q1 = quantile(Abundance)[2],
            q3 = quantile(Abundance)[4]) %>%
  ungroup()

top_phylum <- top_phylum %>% arrange(desc(mean_abundance))
top_phylum <- as.data.frame(top_phylum)
top_phyla <- c("p__Bacillota_A",
               "p__Firmicutes_A",
               "p__Proteobacteria",
               "p__Firmicutes_C",
               "p__Actinobacteriota")


abund_df <- abund_df %>%
  dplyr::mutate(pick_Phylum = ifelse(Phylum %in%
                                       top_phyla,
                                     yes = Phylum,
                                     "Others"))

# Plot
abund_df$pick_Phylum <- as.factor(abund_df$pick_Phylum)
abund_df$pick_Phylum <- factor(abund_df$pick_Phylum,
  levels = c(top_phyla, "Others")
)

abund_df <- abund_df[order(abund_df$host.age, decreasing = FALSE), ]

abund_plot <-
  ggplot(abund_df, aes(x = Sam_rep, y = Abundance, fill = pick_Phylum)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_fill_manual(values = c("p__Bacteroidota" = "#6388B4",
                               "p__Firmicutes_A" = "#FFAE34",
                               "p__Proteobacteria" = "#EF6F6A",
                               "p__Firmicutes_C" = "#8CC2CA",
                               "p__Actinobacteriota" = "#F1FAEE",
                               "Others" = "grey75"),
    breaks = c(top_phyla, "Others"),
  ) +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

# Genus
```{r}
ps_genus <- microbiome::aggregate_rare(all.fil,
  level = "Genus",
  detection = 0.1,
  prevalence = 0
)

abund_df <- microbiomeutilities::phy_to_ldf(
  ps_genus,
  transform.counts = "compositional"
)

top_genus <- abund_df %>%
  group_by(Genus) %>%
  summarise(mean_abundance = mean(Abundance),
            se = se(Abundance),
            median = median(Abundance),
            q1 = quantile(Abundance)[2],
            q3 = quantile(Abundance)[4]) %>%
  ungroup()

top_genus <- top_genus %>% arrange(desc(mean_abundance))
top_genus <- as.data.frame(top_genus)


abund_df <- abund_df %>%
  dplyr::mutate(pick_genus = ifelse(Genus %in% top_genus,
                                    yes = Genus,
                                    "Others"))

# Plot
abund_df$pick_genus <- as.factor(abund_df$pick_genus)
abund_df$pick_genus <- factor(abund_df$pick_genus,
  levels = c(top_genus, "Others")
)

abund_df <- abund_df[order(abund_df$host.age, decreasing = FALSE), ]

abund_plot <-
  ggplot(abund_df, aes(x = Sam_rep, y = Abundance, fill = pick_Phylum)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_fill_manual(values = c("p__Bacteroidota" = "#6388B4",
                               "p__Firmicutes_A" = "#FFAE34",
                               "p__Proteobacteria" = "#EF6F6A",
                               "p__Firmicutes_C" = "#8CC2CA",
                               "p__Actinobacteriota" = "#F1FAEE",
                               "Others" = "grey75"),
    breaks = c(top_phyla, "Others"),
  ) +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

```{r}

```